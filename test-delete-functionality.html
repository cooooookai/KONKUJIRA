<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ é™¤åŠŸèƒ½æµ‹è¯• - Band Sync Calendar</title>
    
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/index.global.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.10/index.global.min.css" rel="stylesheet" />
    
    <!-- Custom CSS -->
    <link href="css/styles.css" rel="stylesheet" />
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .test-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .delete-button {
            background: #dc3545;
        }
        
        .delete-button:hover {
            background: #c82333;
        }
        
        .status-display {
            font-family: monospace;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        
        .calendar-container {
            margin-top: 20px;
        }
        
        .instructions {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ—‘ï¸ åˆ é™¤åŠŸèƒ½æµ‹è¯•</h1>
            <p>æµ‹è¯•Band Sync Calendarçš„äº‹ä»¶åˆ é™¤åŠŸèƒ½</p>
        </div>
        
        <div class="instructions">
            <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
            <ol>
                <li>é¦–å…ˆåˆ›å»ºä¸€ä¸ªæµ‹è¯•äº‹ä»¶</li>
                <li>åœ¨æ—¥å†ä¸­ç‚¹å‡»äº‹ä»¶æŸ¥çœ‹è¯¦æƒ…</li>
                <li>å¦‚æœä½ æ˜¯äº‹ä»¶åˆ›å»ºè€…æˆ–COKAIç”¨æˆ·ï¼Œä¼šçœ‹åˆ°åˆ é™¤æŒ‰é’®</li>
                <li>ç‚¹å‡»åˆ é™¤æŒ‰é’®ç¡®è®¤åˆ é™¤</li>
                <li>äº‹ä»¶å°†ä»æ—¥å†ä¸­æ¶ˆå¤±</li>
            </ol>
            <p><strong>æƒé™è¯´æ˜:</strong> åªæœ‰äº‹ä»¶åˆ›å»ºè€…æˆ–COKAIç”¨æˆ·å¯ä»¥åˆ é™¤äº‹ä»¶</p>
        </div>
        
        <div class="test-section">
            <h3>ğŸ§ª æµ‹è¯•æ“ä½œ</h3>
            <button class="test-button" onclick="createTestEvent()">åˆ›å»ºæµ‹è¯•äº‹ä»¶</button>
            <button class="test-button" onclick="loadCalendar()">åˆ·æ–°æ—¥å†</button>
            <button class="test-button" onclick="setNickname('COKAI')">è®¾ç½®ä¸ºCOKAIç”¨æˆ·</button>
            <button class="test-button" onclick="setNickname('ãƒ†ã‚¹ãƒˆå¤ªéƒ')">è®¾ç½®ä¸ºãƒ†ã‚¹ãƒˆå¤ªéƒç”¨æˆ·</button>
            <div id="status" class="status-display">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>
        
        <div class="calendar-container">
            <div id="calendar"></div>
        </div>
    </div>

    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.10/index.global.min.js"></script>
    
    <!-- Application JS -->
    <script src="js/config.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/api.js"></script>
    <script src="js/calendar.js"></script>
    
    <script>
        let calendar = null;
        
        // Initialize calendar
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ja',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth'
                },
                height: 'auto',
                events: [],
                eventClick: function(info) {
                    // Use the calendar manager's event click handler
                    calendarManager.handleEventClick(info);
                }
            });
            
            calendar.render();
            
            // Initialize calendar manager
            calendarManager.calendar = calendar;
            
            // Load initial data
            loadCalendar();
        });
        
        // Set nickname
        function setNickname(nickname) {
            storage.setNickname(nickname);
            updateStatus(`âœ… ç”¨æˆ·è®¾ç½®ä¸º: ${nickname}`);
        }
        
        // Create test event
        async function createTestEvent() {
            const nickname = storage.getNickname();
            if (!nickname) {
                updateStatus('âŒ è¯·å…ˆè®¾ç½®ç”¨æˆ·å');
                return;
            }
            
            updateStatus('ğŸ“ åˆ›å»ºæµ‹è¯•äº‹ä»¶...');
            
            try {
                const eventData = {
                    title: `${nickname}çš„æµ‹è¯•äº‹ä»¶`,
                    type: 'other',
                    start_time: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(), // Tomorrow
                    end_time: new Date(Date.now() + 24 * 60 * 60 * 1000 + 2 * 60 * 60 * 1000).toISOString(), // +2 hours
                    created_by: nickname
                };
                
                const result = await apiClient.createEvent(eventData);
                updateStatus(`âœ… æµ‹è¯•äº‹ä»¶åˆ›å»ºæˆåŠŸ! ID: ${result.id}`);
                
                // Refresh calendar
                await loadCalendar();
                
            } catch (error) {
                updateStatus(`âŒ åˆ›å»ºäº‹ä»¶å¤±è´¥: ${error.message}`);
            }
        }
        
        // Load calendar data
        async function loadCalendar() {
            if (!calendar) return;
            
            updateStatus('ğŸ”„ åŠ è½½æ—¥å†æ•°æ®...');
            
            try {
                const { start, end } = getSyncPeriod();
                
                // Get events and availability
                const [events, availability] = await Promise.all([
                    apiClient.getEvents(start, end),
                    apiClient.getAvailability(start, end)
                ]);
                
                // Combine data
                const allEvents = [...events, ...availability];
                
                // Update calendar
                calendar.removeAllEvents();
                calendar.addEventSource(allEvents);
                
                updateStatus(`âœ… æ—¥å†åŠ è½½å®Œæˆ! å…± ${allEvents.length} ä¸ªé¡¹ç›®\näº‹ä»¶: ${events.length} ä¸ª\nå¯ç”¨æ€§: ${availability.length} ä¸ª`);
                
            } catch (error) {
                updateStatus(`âŒ åŠ è½½å¤±è´¥: ${error.message}`);
            }
        }
        
        // Update status display
        function updateStatus(message) {
            const statusEl = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            statusEl.textContent = `[${timestamp}] ${message}`;
        }
        
        // Override calendar manager's showSuccess method for testing
        if (typeof calendarManager !== 'undefined') {
            calendarManager.showSuccess = function(message) {
                updateStatus(`âœ… ${message}`);
            };
            
            calendarManager.showError = function(message) {
                updateStatus(`âŒ ${message}`);
            };
        }
    </script>
</body>
</html>